@using System.Timers

<div class="timer-container">
    <div class="timer-circle">
        <svg class="progress-ring" viewBox="0 0 300 300" width="100%" height="100%">
            <circle class="progress-ring__circle-bg"
                    stroke="rgba(0,0,0,0.05)"
                    stroke-width="12"
                    fill="transparent"
                    r="140"
                    cx="150"
                    cy="150" />
            <circle class="progress-ring__circle"
                    stroke="var(--pomodoro-color, #E55039)"
                    stroke-width="12"
                    fill="transparent"
                    r="140"
                    cx="150"
                    cy="150"
                    style="stroke-dasharray: @Circumference @Circumference; stroke-dashoffset: @DashOffset" />
        </svg>
        <div class="timer-text">
            @FormatTime(TimeRemaining)
        </div>
    </div>

    <div class="timer-controls-wrapper">
        <TimerControls State="@State"
                       OnStart="StartTimer"
                       OnPause="PauseTimer"
                       OnResume="ResumeTimer"
                       OnCancel="RequestCancel" />
    </div>
    
    <PomodoroFocus.Web.Components.Modals.CancelConfirmModal 
        IsVisible="@ShowCancelModal"
        OnClose="@(() => ShowCancelModal = false)"
        OnConfirmCompleted="HandleCompleted"
        OnConfirmNotCompleted="HandleNotCompleted" />
</div>

@using PomodoroFocus.Domain.Enums

@code {
    [Parameter] public TimeSpan TimeRemaining { get; set; } = TimeSpan.FromMinutes(25);
    [Parameter] public TimerState State { get; set; } = TimerState.Ready;
    
    private bool ShowCancelModal { get; set; } = false;

    // Total duration for progress calculation (mock default 25m)
    private TimeSpan TotalDuration = TimeSpan.FromMinutes(25);
    private double Circumference = 2 * Math.PI * 140; 
    private double DashOffset => Circumference - (TimeRemaining.TotalSeconds / TotalDuration.TotalSeconds) * Circumference;

    private Timer? _timer;

    private string FormatTime(TimeSpan time) => $"{(int)time.TotalMinutes:D2}:{time.Seconds:D2}";

    private void StartTimer()
    {
        State = TimerState.Running;
        _timer = new Timer(1000);
        _timer.Elapsed += async (sender, e) => 
        {
            if (TimeRemaining.TotalSeconds > 0)
            {
                TimeRemaining = TimeRemaining.Subtract(TimeSpan.FromSeconds(1));
                await InvokeAsync(StateHasChanged);
            }
            else
            {
                _timer?.Stop();
                State = TimerState.Ready; // Reset for demo
                await InvokeAsync(StateHasChanged);
            }
        };
        _timer.Start();
    }

    private void PauseTimer()
    {
        State = TimerState.Paused;
        _timer?.Stop();
    }

    private void ResumeTimer()
    {
        State = TimerState.Running;
        _timer?.Start();
    }

    private void RequestCancel()
    {
        // Pause timer while modal is open (optional, but good UX)
        if (State == TimerState.Running) PauseTimer();
        ShowCancelModal = true;
    }

    private void HandleCompleted()
    {
        ShowCancelModal = false;
        ResetTimer();
        // TODO: Increment completed count
    }

    private void HandleNotCompleted()
    {
        ShowCancelModal = false;
        ResetTimer();
    }

    private void ResetTimer()
    {
        State = TimerState.Ready;
        _timer?.Stop();
        TimeRemaining = TotalDuration;
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
